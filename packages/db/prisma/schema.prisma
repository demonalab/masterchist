generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum City {
  ROSTOV_NA_DONU
  BATAYSK
  STAVROPOL
}

enum ServiceCode {
  self_cleaning
  pro_cleaning
  cleaning
}

enum BookingStatus {
  new
  awaiting_prepayment
  prepaid
  confirmed
  cancelled
}

enum BookingSource {
  telegram_bot
  telegram_miniapp
  max_bot
}

model User {
  id           String   @id @default(uuid())
  telegramId   String?  @unique @db.VarChar(32)
  maxId        String?  @unique @db.VarChar(32)
  username     String?  @db.VarChar(64)
  firstName    String?  @db.VarChar(128)
  lastName     String?  @db.VarChar(128)
  languageCode String?  @db.VarChar(16)
  phone        String?  @unique @db.VarChar(20)
  passwordHash String?  @db.VarChar(256)
  isAdmin      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  addresses Address[]
  bookings  Booking[]

  @@index([telegramId])
  @@index([maxId])
  @@index([phone])
}

model Service {
  id           String      @id @default(uuid())
  code         ServiceCode @unique
  title        String      @db.VarChar(128)
  priceRub     Int
  prepaymentRub Int?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  bookings Booking[]
}

model CleaningKit {
  id        String   @id @default(uuid())
  number    Int      @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings Booking[]
}

model TimeSlot {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(16)
  startTime String   @db.VarChar(5)
  endTime   String   @db.VarChar(5)
  sortOrder Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings Booking[]

  @@index([sortOrder])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  city         City
  district     String?  @db.VarChar(64)
  addressLine  String   @db.Text
  contactName  String   @db.VarChar(128)
  contactPhone String   @db.VarChar(32)
  comment      String?  @db.Text
  label        String?  @db.VarChar(50)  // "Дом", "Офис", etc.
  isDefault    Boolean  @default(false)
  isSaved      Boolean  @default(false)  // true = saved address, false = one-time booking address
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([userId])
  @@index([city])
  @@index([userId, isSaved])
}

model Booking {
  id                    String        @id @default(uuid())
  userId                String
  serviceId             String
  status                BookingStatus @default(new)

  addressId             String?
  scheduledDate         DateTime?     @db.Date
  timeSlotId            String?
  cleaningKitId         String?

  proCleaningDetails    String?       @db.Text
  proCleaningPhotoFileIds String[]    @default([])
  source                BookingSource @default(telegram_bot)

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  service     Service      @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  address     Address?     @relation(fields: [addressId], references: [id], onDelete: SetNull)
  timeSlot    TimeSlot?    @relation(fields: [timeSlotId], references: [id], onDelete: Restrict)
  cleaningKit CleaningKit? @relation(fields: [cleaningKitId], references: [id], onDelete: Restrict)

  paymentProofs PaymentProof[]
  statusHistory BookingStatusHistory[]

  @@unique([cleaningKitId, scheduledDate, timeSlotId], map: "uniq_kit_date_slot")
  @@index([userId, createdAt])
  @@index([serviceId, status])
  @@index([scheduledDate, timeSlotId])
}

model PaymentProof {
  id            String   @id @default(uuid())
  bookingId     String
  telegramFileId String  @db.VarChar(256)
  photoUrl      String?  @db.Text
  mimeType      String?  @db.VarChar(64)
  fileName      String?  @db.VarChar(256)
  createdAt     DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
}

enum AdminRole {
  super_admin
  admin
}

model Admin {
  id             String    @id @default(uuid())
  telegramId     String    @unique @db.VarChar(32)
  role           AdminRole @default(admin)
  name           String?   @db.VarChar(128)
  addedBy        String?   @db.VarChar(32)
  isActive       Boolean   @default(true)
  notifyTelegram Boolean   @default(true)
  notifyMax      Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([telegramId])
}

model AbandonedConversation {
  id              String      @id @default(uuid())
  telegramId      String      @db.VarChar(32)
  serviceCode     ServiceCode
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  reminder2hSent  Boolean     @default(false)
  reminderNextDay Boolean     @default(false)
  
  @@index([telegramId, completedAt])
  @@index([startedAt, completedAt])
}

model BookingStatusHistory {
  id        String        @id @default(uuid())
  bookingId String
  status    BookingStatus
  comment   String?       @db.Text
  changedBy String?       @db.VarChar(32) // admin telegramId or 'system'
  createdAt DateTime      @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
}

model CitySettings {
  id               String  @id @default(uuid())
  city             City    @unique
  isActive         Boolean @default(true)
  deliveryPriceRub Int     @default(0)
  minOrderRub      Int?    
  workingHoursFrom String? @db.VarChar(5) // "09:00"
  workingHoursTo   String? @db.VarChar(5) // "21:00"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
